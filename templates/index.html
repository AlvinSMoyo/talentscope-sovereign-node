<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalentScope Sovereign</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { 
            --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; 
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); 
            margin: 0; display: flex; height: 100vh; overflow: hidden; 
        }
        
        .sidebar { width: 260px; background: #111827; border-right: 1px solid #334155; flex-shrink: 0; }
        .sidebar-header { padding: 40px 30px; border-bottom: 1px solid #334155; }
        .sidebar-header h3 { margin: 0 0 8px 0; }
        .sidebar-status { color: var(--accent); font-size: 0.7rem; font-weight: 600; }
        
        .nav-item { 
            padding: 18px 25px; display: flex; align-items: center; gap: 12px;
            color: #cbd5e1; text-decoration: none; border-left: 4px solid transparent; transition: all 0.2s;
        }
        .nav-item:hover { background: #1a2234; color: white; }
        .nav-item.active { background: #1e293b; color: white; border-left-color: var(--accent); }
        
        .main { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: 550px 1fr; gap: 40px; }
        
        .card { 
            background: var(--card); padding: 25px; border-radius: 12px; 
            border: 1px solid #334155; margin-bottom: 25px; 
        }
        .card h4 { margin-top: 0; margin-bottom: 20px; color: var(--accent); }
        
        /* Campaign card accents */
        .card-linkedin { border-left: 5px solid #0077B5; }
        .card-equality { border-left: 5px solid var(--success); }
        .card-jobboard { border-left: 5px solid var(--warning); }
        
        input, textarea, select { 
            width: 100%; padding: 14px; margin: 10px 0; background: #0f172a; 
            border: 1px solid #334155; color: white; border-radius: 6px; font-family: inherit;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); }
        
        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 6px; 
            font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.85rem; transition: all 0.2s;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-gen { background: var(--warning); color: black; }
        .btn-main { background: #3b82f6; color: white; margin-top: 15px; }
        .btn-marketing { background: #8b5cf6; color: white; }
        .btn-utility { background: #475569; color: #cbd5e1; font-size: 0.75rem; padding: 10px 12px; font-weight: 600; text-transform: none; }
        .btn-utility:hover:not(:disabled) { background: #64748b; }
        
        .utility-row { display: flex; gap: 10px; margin-top: 15px; }
        
        .badge-mode { 
            padding: 8px 16px; border-radius: 6px; cursor: pointer; background: #111827; 
            border: 1px solid #334155; color: #94a3b8; font-weight: bold; transition: all 0.2s;
        }
        .badge-mode:hover { border-color: #64748b; }
        .badge-mode.active { background: rgba(56,189,248,0.15); color: var(--accent); border-color: var(--accent); }
        
        .pill { 
            font-size: 0.7rem; border: 1px solid #334155; padding: 4px 10px; 
            border-radius: 4px; margin-right: 6px; background: #0f172a; display: inline-block;
        }
        
        .slider { 
            width: 100%; height: 8px; background: #334155; border-radius: 5px; 
            appearance: none; margin: 15px 0; cursor: pointer;
        }
        .slider::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: var(--accent); border-radius: 50%; }
        .slider::-moz-range-thumb { width: 18px; height: 18px; background: var(--accent); border-radius: 50%; border: none; }
        
        .candidate-card { cursor: pointer; transition: all 0.2s; position: relative; }
        .candidate-card:hover { transform: translateX(5px); box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        .candidate-card.below-threshold { opacity: 0.7; border-left: 6px solid #64748b !important; }
        .candidate-card.below-threshold::before {
            content: "BELOW THRESHOLD"; position: absolute; top: 10px; right: 80px;
            background: #64748b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;
        }
        
        .score-badge { float: right; font-weight: bold; font-size: 1.3rem; }
        
        .loading-spinner {
            display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid; }
        .alert-success { background: rgba(34, 197, 94, 0.1); border-left-color: var(--success); color: #86efac; }
        .alert-error { background: rgba(239, 68, 68, 0.1); border-left-color: var(--danger); color: #fca5a5; }
        
        .threshold-indicator {
            background: rgba(56, 189, 248, 0.1); border: 2px dashed var(--accent);
            padding: 12px; border-radius: 6px; margin: 15px 0; text-align: center; font-size: 0.85rem;
        }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid #334155; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; }
        
        .message-preview { background: #0f172a; padding: 15px; border-radius: 6px; margin: 15px 0; border-left: 4px solid var(--accent); }
        .message-preview.regret { border-left-color: #64748b; }
        
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-box { background: #0f172a; padding: 20px; border-radius: 8px; border: 1px solid #334155; }
        
        .status-badge {
            display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; 
            font-weight: 600; text-transform: uppercase;
        }
        .status-applied { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .status-screened { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .status-interviewed { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .status-rejected { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        .ingestion-stat {
            background: rgba(56, 189, 248, 0.1); padding: 12px; border-radius: 6px; 
            margin: 15px 0; display: flex; justify-content: space-around; font-size: 0.85rem;
        }
        
        .log-entry { 
            padding: 10px; border-left: 3px solid #334155; margin: 8px 0; 
            background: #0f172a; border-radius: 4px; font-size: 0.85rem;
        }
        .log-timestamp { color: #64748b; font-size: 0.75rem; }
        
        .campaign-content { 
            white-space: pre-wrap; line-height: 1.6; background: #0f172a; 
            padding: 20px; border-radius: 6px; font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>TalentScope</h3>
            <div class="sidebar-status">● SOVEREIGN NODE</div>
        </div>
        <nav style="margin-top:20px;">
            <a href="/pipeline" class="nav-item {% if view == 'pipeline' %}active{% endif %}">
                <i class="fas fa-industry"></i> <span>Pipeline Engine</span>
            </a>
            <a href="/review" class="nav-item {% if view == 'review' %}active{% endif %}">
                <i class="fas fa-user-check"></i> <span>Talent Review</span>
            </a>
            <a href="/config" class="nav-item {% if view == 'config' %}active{% endif %}">
                <i class="fas fa-cog"></i> <span>Sovereign Config</span>
            </a>
        </nav>
    </div>
    
    <div class="main">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <div>
                <h2 style="margin:0;">
                    {% if view == 'pipeline' %}Pipeline Engine
                    {% elif view == 'review' %}Talent Review
                    {% else %}Sovereign Config{% endif %}
                </h2>
                <div id="stats" style="font-size:0.85rem; margin-top:8px; opacity:0.7;">
                    <i class="fas fa-database"></i> Loading...
                </div>
            </div>
            {% if view != 'config' %}
            <button class="btn" onclick="bulkDecision()" id="bulk-btn" style="width:auto; background:var(--accent); color:black; padding:12px 24px;">
                <i class="fas fa-paper-plane"></i> Bulk Decisioning
            </button>
            {% endif %}
        </header>

        <div id="alert-container"></div>

        {% if view == 'pipeline' %}
        <div class="grid">
            <div class="controls">
                <div class="card">
                    <h4><i class="fas fa-briefcase"></i> 1. Role Definition</h4>
                    <input type="text" id="role-input" placeholder="e.g., Senior Staff Nurse - ICU">
                    <button id="btn-jd" onclick="generateJD()" class="btn btn-gen">
                        <i class="fas fa-magic"></i> Auto-Generate JD
                    </button>
                    <textarea id="jd-output" rows="12" placeholder="Job description..."></textarea>
                </div>
                
                <div class="card">
                    <h4><i class="fas fa-sliders-h"></i> 2. Actions & Filters</h4>
                    
                    <div class="ingestion-stat">
                        <div><i class="fas fa-envelope"></i> Email: <strong id="email-count">0</strong></div>
                        <div><i class="fas fa-upload"></i> Manual: <strong id="manual-count">0</strong></div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Score Threshold:</span>
                            <span id="thresh-val" style="font-weight: bold; color: var(--accent);">65%</span>
                        </label>
                        <input type="range" class="slider" id="threshold" min="0" max="100" value="65" oninput="updateThreshold(this.value)">
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap;">
                        <button onclick="setMode('new')" id="m-new" class="badge-mode active">
                            <i class="fas fa-user-plus"></i> New
                        </button>
                        <button onclick="setMode('warehouse')" id="m-wh" class="badge-mode">
                            <i class="fas fa-database"></i> Internal DB
                        </button>
                        <button onclick="setMode('marketing')" id="m-mkt" class="badge-mode">
                            <i class="fas fa-bullhorn"></i> Outreach
                        </button>
                    </div>
                    
                    <div id="file-sec">
                        <input type="file" id="cv-upload" multiple accept=".pdf">
                        <button id="btn-run" onclick="runSieve()" class="btn btn-main">
                            <i class="fas fa-cogs"></i> Run Analysis
                        </button>
                        <div class="utility-row">
                            <button onclick="clearMemory()" class="btn-utility" style="flex: 1;">
                                <i class="fas fa-trash-alt"></i> Clear Memory
                            </button>
                            <button onclick="refreshResults()" class="btn-utility" style="flex: 2;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div id="warehouse-sec" style="display:none;">
                        <button id="btn-warehouse" onclick="runSieve()" class="btn btn-main">
                            <i class="fas fa-search"></i> Scan Warehouse
                        </button>
                        <div class="utility-row">
                            <button onclick="clearMemory()" class="btn-utility" style="flex: 1;">
                                <i class="fas fa-trash-alt"></i> Clear
                            </button>
                            <button onclick="refreshResults()" class="btn-utility" style="flex: 2;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div id="ad-sec" style="display:none;">
                        <button onclick="runAds()" id="btn-ads" class="btn btn-marketing">
                            <i class="fas fa-rocket"></i> Generate Content
                        </button>
                        <div class="utility-row">
                            <button onclick="refreshResults()" class="btn-utility" style="width: 100%;">
                                <i class="fas fa-sync-alt"></i> Clear Campaign
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card" id="res-area">
                <h4><i class="fas fa-chart-line"></i> Results</h4>
                <p style="opacity: 0.6; text-align: center; padding: 40px 20px;">
                    <i class="fas fa-inbox" style="font-size: 3rem; display: block; margin-bottom: 15px; opacity: 0.3;"></i>
                    Ready for analysis
                </p>
            </div>
        </div>
        
        {% elif view == 'review' %}
        
        <div class="analytics-grid">
            <div class="chart-box">
                <h4 style="margin-top:0; color: var(--accent);"><i class="fas fa-chart-pie"></i> Industry Distribution</h4>
                <canvas id="industryChart" style="max-height: 200px;"></canvas>
            </div>
            <div class="chart-box">
                <h4 style="margin-top:0; color: var(--accent);"><i class="fas fa-chart-bar"></i> Score Distribution</h4>
                <canvas id="scoreChart" style="max-height: 200px;"></canvas>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h4><i class="fas fa-user-check"></i> Candidate Details</h4>
                <div id="aud-info">
                    <p style="opacity: 0.6; text-align: center; padding: 40px 20px;">
                        Select a candidate from Pipeline Engine
                    </p>
                </div>
            </div>
            
            <div class="card">
                <h4><i class="fas fa-clipboard-list"></i> Management</h4>
                
                <label style="font-size: 0.9rem; color: #94a3b8; display: block; margin-bottom: 5px;">Status</label>
                <select id="candidate-status" onchange="updateCandidateStatus()">
                    <option value="Applied">Applied</option>
                    <option value="Screened">Screened</option>
                    <option value="Interviewed">Interviewed</option>
                    <option value="Rejected">Rejected</option>
                </select>
                
                <label style="font-size: 0.9rem; color: #94a3b8; display: block; margin-bottom: 5px; margin-top: 15px;">Notes</label>
                <textarea id="candidate-notes" rows="6" placeholder="Add notes..."></textarea>
                <button class="btn btn-utility" onclick="saveCandidateNotes()" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-save"></i> Save Notes
                </button>
                
                <hr style="border: none; border-top: 1px solid #334155; margin: 25px 0;">
                
                <label style="font-size: 0.9rem; color: #94a3b8; display: block; margin-bottom: 5px;">Email</label>
                <input id="g-email" placeholder="candidate@example.com">
                
                <label style="font-size: 0.9rem; color: #94a3b8; display: block; margin-bottom: 5px; margin-top: 15px;">Message</label>
                <textarea id="g-msg" rows="10" placeholder="Message..."></textarea>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-main" onclick="sendSingleEmail()" style="flex: 1;">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                    <button class="btn btn-utility" onclick="clearReview()" style="flex: 1;">
                        <i class="fas fa-eraser"></i> Clear
                    </button>
                </div>
            </div>
        </div>
        
        {% else %}
        
	<div class="card">
    	    <h4><i class="fas fa-envelope"></i> IMAP Email Sync</h4>
    	    <p style="opacity: 0.8; margin-bottom: 20px;">
        	Automatically ingest CVs from recruitment@talentscope-pilot.pro<br>
        	<small style="color: var(--success);">✓ Auto-acknowledgment enabled - candidates receive instant confirmation</small>
    	    </p>
    
    	    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        	<div>
            	    <label style="font-size: 0.9rem; color: #94a3b8; display: block; margin-bottom: 5px;">IMAP Server</label>
            	    <input type="text" value="mail.privateemail.com" disabled>
        	</div>
        	<div>
            	    <label style="font-size: 0.9rem; color: #94a3b8; display: block; margin-bottom: 5px;">Email Address</label>
            	    <input type="text" value="recruitment@talentscope-pilot.pro" disabled>
        	</div>
    	    </div>
    
    	    <button class="btn btn-main" onclick="syncEmail()" id="sync-btn">
        	<i class="fas fa-sync"></i> Sync Inbox Now
    	    </button>
    
    	    <div id="sync-result" style="margin-top: 20px;"></div>
	</div>

        
        <div class="card">
            <h4><i class="fas fa-key"></i> API Configuration</h4>
            <p style="opacity: 0.8; margin-bottom: 20px;">Manage API keys in .env file on server</p>
            
            <div style="background: #0f172a; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 0.85rem;">
                OPENAI_API_KEY=sk-***<br>
                BREVO_API_KEY=xkeysib-***<br>
                IMAP_SERVER=mail.privateemail.com<br>
                IMAP_PASSWORD=***<br>
                SENDER_EMAIL=recruitment@talentscope-pilot.pro<br>
                SENDER_NAME=Alvin - TalentScope
            </div>
        </div>
        
        <div class="card">
            <h4><i class="fas fa-history"></i> System Logs</h4>
            <button class="btn btn-utility" onclick="loadLogs()" style="width: auto; margin-bottom: 15px;">
                <i class="fas fa-sync"></i> Refresh Logs
            </button>
            <div id="logs-container" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
        
        {% endif %}
    </div>
    
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;"><i class="fas fa-envelope-open-text"></i> Preview</h3>
                <button class="modal-close" onclick="closePreviewModal()">&times;</button>
            </div>
            <div id="preview-content"></div>
            <button class="btn btn-main" onclick="confirmBulkSend()" style="margin-top: 20px;">
                <i class="fas fa-paper-plane"></i> Confirm & Send
            </button>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let mode = 'new';
        let currentThreshold = 65;
        let allCandidates = [];
        let currentCandidate = null;
        
        function updateThreshold(value) {
            currentThreshold = parseInt(value);
            document.getElementById('thresh-val').innerText = value + '%';
            localStorage.setItem('threshold', value);
            if (allCandidates.length > 0) displayResults(allCandidates, currentThreshold);
        }
        
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                document.getElementById('stats').innerHTML = `
                    <i class="fas fa-users"></i> ${data.total_candidates} Active | 
                    <i class="fas fa-file-pdf"></i> ${data.total_cvs_stored} Stored
                `;
                
                if (document.getElementById('email-count')) {
                    document.getElementById('email-count').innerText = data.email_ingestion;
                    document.getElementById('manual-count').innerText = data.manual_ingestion;
                }
            } catch (e) { console.error(e); }
        }
        
        async function loadAnalytics() {
            try {
                const res = await fetch('/get_analytics');
                const data = await res.json();
                
                const industryCtx = document.getElementById('industryChart');
                if (industryCtx) {
                    new Chart(industryCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(data.industry_distribution),
                            datasets: [{
                                data: Object.values(data.industry_distribution),
                                backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#22c55e']
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { labels: { color: '#f1f5f9' } } } }
                    });
                }
                
                const scoreCtx = document.getElementById('scoreChart');
                if (scoreCtx) {
                    new Chart(scoreCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(data.score_distribution),
                            datasets: [{
                                label: 'Candidates',
                                data: Object.values(data.score_distribution),
                                backgroundColor: '#38bdf8'
                            }]
                        },
                        options: { 
                            responsive: true,
                            scales: { 
                                y: { ticks: { color: '#f1f5f9' }, grid: { color: '#334155' } },
                                x: { ticks: { color: '#f1f5f9' }, grid: { color: '#334155' } }
                            },
                            plugins: { legend: { labels: { color: '#f1f5f9' } } }
                        }
                    });
                }
            } catch (e) { console.error(e); }
        }
        
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            container.appendChild(alert);
            setTimeout(() => { alert.style.opacity = '0'; setTimeout(() => alert.remove(), 300); }, 5000);
        }
        
        function setMode(m) {
            mode = m;
            document.getElementById('file-sec').style.display = m === 'new' ? 'block' : 'none';
            document.getElementById('warehouse-sec').style.display = m === 'warehouse' ? 'block' : 'none';
            document.getElementById('ad-sec').style.display = m === 'marketing' ? 'block' : 'none';
            document.querySelectorAll('.badge-mode').forEach(b => b.classList.remove('active'));
            document.getElementById('m-'+(m==='new'?'new':m==='warehouse'?'wh':'mkt')).classList.add('active');
        }
        
        function refreshResults() {
    	    // Mode-aware confirmation
    	    const context = (mode === 'marketing') ? 'JD and campaign content' : 'JD and analysis results';
    
    	    if (confirm(`Clear ${context}?`)) {  // ← Fix: Use backticks ` not regular quotes
        	// 1. Clear the Candidate Data
        	allCandidates = [];
        	localStorage.removeItem('candidates');
        
        	// 2. Clear the JD Storage (The fix you wanted)
        	document.getElementById('role-input').value = '';
        	document.getElementById('jd-output').value = '';
        	localStorage.removeItem('lastRole');
        	localStorage.removeItem('lastJD');
        
        	// 3. Reset the UI Area
        	const area = document.getElementById('res-area');
        	area.innerHTML = `
            	    <h4><i class="fas fa-chart-line"></i> Results</h4>
            	    <p style="opacity: 0.6; text-align: center; padding: 40px 20px;">
                	<i class="fas fa-inbox" style="font-size: 3rem; display: block; margin-bottom: 15px; opacity: 0.3;"></i>
                	Workspace cleared. Ready for a new Sovereign Harvest.
            	    </p>
        	`;
        
        	showAlert('Workspace cleared successfully', 'success');
    	    }
	}
        
        async function generateJD() {
            const roleInput = document.getElementById('role-input');
            const jdOutput = document.getElementById('jd-output');
            const btn = document.getElementById('btn-jd');
            const role = roleInput.value.trim();
            if (!role) { showAlert('Enter role', 'error'); return; }
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Generating...';
            try {
                const res = await fetch('/generate_jd', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ role_title: role }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                jdOutput.value = data.jd_text;
                localStorage.setItem('lastRole', role);
                localStorage.setItem('lastJD', data.jd_text);
                showAlert('JD generated', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Auto-Generate JD';
            }
        }
        
        async function runSieve() {
            const area = document.getElementById('res-area');
            const jdText = document.getElementById('jd-output').value.trim();
            const btn = mode === 'warehouse' ? document.getElementById('btn-warehouse') : document.getElementById('btn-run');
            if (!jdText) { showAlert('Need JD', 'error'); return; }
            if (mode === 'new' && document.getElementById('cv-upload').files.length === 0) { showAlert('Select CVs', 'error'); return; }
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Processing...';
            area.innerHTML = '<h4>Processing...</h4><p style="text-align: center; padding: 40px;"><span class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></span></p>';
            try {
                const formData = new FormData();
                formData.append('full_jd', jdText);
                formData.append('mode', mode);
                if (mode === 'new') for (let file of document.getElementById('cv-upload').files) formData.append('files', file);
                const res = await fetch('/analyze_tribunal', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                allCandidates = data;
                localStorage.setItem('candidates', JSON.stringify(data));
                localStorage.setItem('lastJD', jdText);
                displayResults(data, currentThreshold);
                showAlert(`Analysed ${data.length} candidates`, 'success');
                loadStats();
            } catch (error) {
                showAlert(error.message, 'error');
                area.innerHTML = `<h4>Failed</h4><p style="color: var(--danger);">${error.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = mode === 'warehouse' ? '<i class="fas fa-search"></i> Scan Warehouse' : '<i class="fas fa-cogs"></i> Run Analysis';
            }
        }
        
        function displayResults(candidates, threshold) {
            const area = document.getElementById('res-area');
            area.innerHTML = '<h4><i class="fas fa-chart-line"></i> Results</h4>';
            if (candidates.length === 0) {
                area.innerHTML += '<p style="opacity: 0.6; text-align: center; padding: 40px;">No matches</p>';
                return;
            }
            const aboveCount = candidates.filter(c => c.score >= threshold).length;
            area.innerHTML += `<div class="threshold-indicator"><strong>${threshold}%</strong><br><span style="color: var(--success);">${aboveCount} Shortlist</span> | <span style="color: #94a3b8;">${candidates.length - aboveCount} Regret</span></div>`;
            candidates.forEach(c => {
                const scoreColor = c.score >= 85 ? 'var(--success)' : c.score >= 70 ? 'var(--warning)' : '#3b82f6';
                const belowThreshold = c.score < threshold;
                area.innerHTML += `<div class="card candidate-card ${belowThreshold ? 'below-threshold' : ''}" onclick='goReview("${c.candidate_name}")' style="border-left-color: ${scoreColor}"><span class="score-badge" style="color: ${scoreColor}">${c.score}%</span><h4>${c.candidate_name}</h4><div style="margin:10px 0;"><span class="pill">Stat: ${c.stat_score}%</span><span class="pill">Tech: ${c.tech_score}%</span><span class="pill">Team: ${c.team_score}%</span></div><p style="font-size:0.9rem; opacity:0.9; line-height: 1.5;">${c.summary}</p></div>`;
            });
        }
        
        async function goReview(name) {
            try {
                const res = await fetch(`/get_candidate_data?name=${encodeURIComponent(name)}`);
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                localStorage.setItem("candidateData", JSON.stringify(data));
                window.location.href = "/review";
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        async function runAds() {
            const area = document.getElementById('res-area');
            const jdText = document.getElementById('jd-output').value.trim();
            const btn = document.getElementById('btn-ads');
            if (!jdText) { showAlert('Need JD', 'error'); return; }
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Generating...';
            area.innerHTML = '<h4>Generating...</h4><p style="text-align: center;"><span class="loading-spinner"></span></p>';
            try {
                const res = await fetch('/generate_campaign', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ full_jd: jdText }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                
                // Use job_boards_html (with bold formatting) if available
                const jobBoardContent = data.job_boards_html || data.job_boards;
                
                area.innerHTML = `
                    <h4><i class="fas fa-chart-line"></i> Campaign Content</h4>
                    <div class="card card-equality">
                        <h4><i class="fas fa-balance-scale"></i> Equality Audit</h4>
                        <p style="line-height: 1.6;">${data.compliance_report}</p>
                    </div>
                    <div class="card card-linkedin">
                        <h4><i class="fab fa-linkedin"></i> LinkedIn Post</h4>
                        <div class="campaign-content">${data.linkedin}</div>
                    </div>
                    <div class="card card-jobboard">
                        <h4><i class="fas fa-briefcase"></i> Job Board Advertisement</h4>
                        <div class="campaign-content">${jobBoardContent}</div>
                    </div>
                `;
                showAlert('Generated', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-rocket"></i> Generate Content';
            }
        }
        
	async function syncEmail() {
    	    const btn = document.getElementById('sync-btn');
    	    try {
        	btn.disabled = true;
        	btn.innerHTML = '<span class="loading-spinner"></span> Syncing inbox...';
        
        	showAlert('Syncing inbox...', 'success');
        	const res = await fetch('/sync_email', { method: 'POST' });
        	const data = await res.json();
        
        	if (!res.ok) throw new Error(data.error);
        
        	// Enhanced result display
        	const resultHTML = `
            	    <div class="alert alert-success">
                	<strong>✓ Sync Complete</strong><br>
                	<div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                    	    <div style="background: rgba(56, 189, 248, 0.1); padding: 12px; border-radius: 6px;">
                        	<div style="font-size: 1.5rem; font-weight: bold; color: var(--accent);">${data.new_cvs}</div>
                        	<div style="font-size: 0.8rem; opacity: 0.8;">New CVs</div>
                    	    </div>
                    	    <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 6px;">
                        	<div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${data.acknowledgments_sent}</div>
                        	<div style="font-size: 0.8rem; opacity: 0.8;">Emails Sent</div>
                    	    </div>
                    	    <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 6px;">
                        	<div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${data.total_emails_processed}</div>
                        	<div style="font-size: 0.8rem; opacity: 0.8;">Total Emails</div>
                    	    </div>
                	</div>
            	    </div>
        	`;
        
        	document.getElementById('sync-result').innerHTML = resultHTML;
        	loadStats();
        
    	    } catch (error) {
        	document.getElementById('sync-result').innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    	    } finally {
        	btn.disabled = false;
        	btn.innerHTML = '<i class="fas fa-sync"></i> Sync Inbox Now';
    	    }
	}
        
        async function loadLogs() {
            try {
                const res = await fetch('/get_logs');
                const logs = await res.json();
                const container = document.getElementById('logs-container');
                container.innerHTML = logs.map(log => `
                    <div class="log-entry">
                        <div class="log-timestamp">${new Date(log.timestamp).toLocaleString()}</div>
                        <strong>${log.type}:</strong> ${log.message}
                    </div>
                `).reverse().join('');
            } catch (e) { console.error(e); }
        }
        
        async function updateCandidateStatus() {
            if (!currentCandidate) return;
            const status = document.getElementById('candidate-status').value;
            try {
                await fetch('/update_candidate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ candidate_name: currentCandidate.candidate_name, status: status }) });
                showAlert('Status updated', 'success');
            } catch (e) { showAlert('Failed', 'error'); }
        }
        
        async function saveCandidateNotes() {
            if (!currentCandidate) return;
            const notes = document.getElementById('candidate-notes').value;
            try {
                await fetch('/update_candidate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ candidate_name: currentCandidate.candidate_name, notes: notes }) });
                showAlert('Notes saved', 'success');
            } catch (e) { showAlert('Failed', 'error'); }
        }
        
        async function bulkDecision() {
            if (allCandidates.length === 0) { showAlert('No candidates', 'error'); return; }
            try {
                const res = await fetch('/bulk_decision', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ threshold: currentThreshold, preview_only: true }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                const previewContent = document.getElementById('preview-content');
                previewContent.innerHTML = '<p><strong>Sample messages (first 3):</strong></p>';
                for (const [name, msg] of Object.entries(data.preview_messages)) {
                    previewContent.innerHTML += `<div class="message-preview ${msg.type === 'regret' ? 'regret' : ''}"><strong>${name}</strong> - ${msg.type.toUpperCase()}<p style="margin-top: 10px; white-space: pre-wrap; font-size: 0.9rem;">${msg.message}</p></div>`;
                }
                document.getElementById('preview-modal').classList.add('active');
            } catch (error) { showAlert(error.message, 'error'); }
        }
        
        function closePreviewModal() { document.getElementById('preview-modal').classList.remove('active'); }
        
        async function confirmBulkSend() {
            closePreviewModal();
            const btn = document.getElementById('bulk-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Sending...';
            try {
                const res = await fetch('/bulk_decision', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ threshold: currentThreshold, preview_only: false }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                alert(`Complete:\n✓ ${data.shortlisted.length} Shortlisted\n✓ ${data.regrets.length} Regrets`);
                showAlert('Emails sent', 'success');
            } catch (error) { showAlert(error.message, 'error'); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i> Bulk Decisioning'; }
        }
        
        async function sendSingleEmail() {
            const email = document.getElementById('g-email').value.trim();
            const message = document.getElementById('g-msg').value.trim();
            if (!email || !message) { showAlert('Fill fields', 'error'); return; }
            try {
                const res = await fetch('/send_outreach', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email, message: message, candidate_name: currentCandidate?.candidate_name || '' }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                showAlert('Email sent', 'success');
                document.getElementById('g-email').value = '';
                document.getElementById('g-msg').value = '';
            } catch (error) { showAlert(error.message, 'error'); }
        }
        
        function clearReview() {
            localStorage.removeItem('candidateData');
            document.getElementById('aud-info').innerHTML = '<p style="opacity: 0.6; text-align: center; padding: 40px;">Cleared</p>';
            document.getElementById('g-email').value = '';
            document.getElementById('g-msg').value = '';
            document.getElementById('candidate-notes').value = '';
            currentCandidate = null;
            showAlert('Cleared', 'success');
        }
        
        async function clearMemory() {
            if (!confirm('Delete all CVs?')) return;
            try {
                const res = await fetch('/clear_memory', { method: 'POST' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                showAlert(`Deleted ${data.cvs_deleted} CVs`, 'success');
                allCandidates = [];
                localStorage.clear();
                loadStats();
            } catch (error) { showAlert(error.message, 'error'); }
        }
        
        window.onload = () => {
            loadStats();
            
            const lastRole = localStorage.getItem('lastRole');
            const lastJD = localStorage.getItem('lastJD');
            const savedCandidates = localStorage.getItem('candidates');
            const savedThreshold = localStorage.getItem('threshold');
            
            if (lastRole && document.getElementById('role-input')) document.getElementById('role-input').value = lastRole;
            if (lastJD && document.getElementById('jd-output')) document.getElementById('jd-output').value = lastJD;
            if (savedCandidates && document.getElementById('res-area')) {
                try { allCandidates = JSON.parse(savedCandidates); displayResults(allCandidates, currentThreshold); } catch(e) {}
            }
            if (savedThreshold && document.getElementById('threshold')) {
                currentThreshold = parseInt(savedThreshold);
                document.getElementById('threshold').value = savedThreshold;
                document.getElementById('thresh-val').innerText = savedThreshold + '%';
            }
            
            const candidateData = JSON.parse(localStorage.getItem('candidateData') || 'null');
            const auditInfo = document.getElementById('aud-info');
            
            if (candidateData && auditInfo) {
                currentCandidate = candidateData;
                const statusClass = `status-${candidateData.status.toLowerCase()}`;
                auditInfo.innerHTML = `
                    <h3 style="margin-top: 0;">${candidateData.candidate_name}</h3>
                    <div style="margin: 15px 0;"><span class="status-badge ${statusClass}">${candidateData.status}</span></div>
                    <div style="margin: 15px 0;">
                        <span class="pill">Stat: ${candidateData.stat_score}%</span>
                        <span class="pill">Tech: ${candidateData.tech_score}%</span>
                        <span class="pill">Team: ${candidateData.team_score}%</span>
                    </div>
                    <p style="line-height: 1.6; margin: 20px 0;"><strong>Summary:</strong><br>${candidateData.summary}</p>
                    <div style="margin-top: 20px;">
                        <strong style="color: var(--accent);">Rationale:</strong>
                        <ul style="margin-top: 10px; line-height: 1.8;">${candidateData.rationale.map(r => `<li>${r}</li>`).join('')}</ul>
                    </div>
                    ${candidateData.cv_filename ? `<a href="/download_cv/${candidateData.cv_filename}" style="color: var(--accent); text-decoration: none;"><i class="fas fa-download"></i> Download CV</a>` : ''}
                `;
                
                if (document.getElementById('candidate-status')) document.getElementById('candidate-status').value = candidateData.status || 'Applied';
                if (document.getElementById('candidate-notes')) document.getElementById('candidate-notes').value = candidateData.notes || '';
                if (document.getElementById('g-email')) document.getElementById('g-email').value = candidateData.email || '';
                if (document.getElementById('g-msg')) document.getElementById('g-msg').value = candidateData.email_body || `Dear ${candidateData.candidate_name},\n\nCongratulations!\n\n${candidateData.rationale[0]}\n\nBest regards,\nTalentScope UK`;
            }
            
            if (document.getElementById('industryChart')) loadAnalytics();
            if (document.getElementById('logs-container')) loadLogs();
        };
    </script>
</body>
</html>
